<footer class="ss_footer" role="contentinfo">
    <div class="container">
        <div class="row">
            <div class="col-md-6">
                <p>&copy; 2025 <strong>Qmunica</strong>. Todos los derechos reservados.</p>
                <p class="small">Documentaci√≥n versi√≥n [[PRODUCTVERSION]]</p>
            </div>
            <div class="col-md-6 text-right">
                <p class="ss_languages">[[LANGS]]</p>
            </div>
        </div>

        <div class="ss_back_to_top">
            <span class="glyphicon glyphicon-chevron-up"></span> Subir
        </div>
    </div>
</footer>

<!-- JavaScript -->
<script src="../vendor/jquery/jquery.min.js"></script>
<script src="../vendor/bootstrap/js/bootstrap.min.js"></script>
<script src="js/search_index.js"></script>
<script type="text/javascript">
    $(document).ready(function () {
        $(".ss_body img").addClass("img-thumbnail");
        $(".ss_body table").addClass("table table-striped");

        // Set the selected page based on the TOC name
        $("#side-nav a").each(function () {
            // Note: Data attributes not usually set on body in this implementation, but keeping legacy logic just in case
        });

        $(".ss_back_to_top").click(function () {
            $('html, body').animate({ scrollTop: 0 }, 800);
        });

        // Font Size Control (Buttons)
        var currentFontSize = parseFloat(localStorage.getItem('fontSize')) || 100;

        function setFontSize(size) {
            // Clamp between 100 and 200
            if (size < 100) size = 100;
            if (size > 200) size = 200;

            $('.ss_body').css('font-size', size + '%');
            localStorage.setItem('fontSize', size);
            currentFontSize = size;
        }

        // Initial set
        setFontSize(currentFontSize);

        $('#fontInc').click(function (e) {
            e.preventDefault();
            setFontSize(currentFontSize + 10);
        });

        $('#fontDec').click(function (e) {
            e.preventDefault();
            setFontSize(currentFontSize - 10);
        });

        // Prevent dropdown closing when interacting with slider
        $('.font-settings-dropdown .dropdown-menu').click(function (e) {
            e.stopPropagation();
        });

        // Search Logic
        $('#searchInput').on('keypress', function (e) {
            if (e.which == 13) {
                e.preventDefault();
                var query = $(this).val().toLowerCase();
                if (query.length < 3) return;

                var results = searchData.filter(function (item) {
                    return item.title.toLowerCase().includes(query) || item.content.toLowerCase().includes(query);
                });

                var html = '';
                if (results.length > 0) {
                    html += '<ul class="list-group">';
                    results.forEach(function (item) {
                        // Highlight snippet
                        var snippet = item.content.substring(0, 200) + '...';
                        html += '<li class="list-group-item"><a href="' + item.url + '"><h4>' + item.title + '</h4></a><p>' + snippet + '</p></li>';
                    });
                    html += '</ul>';
                } else {
                    html = '<div class="alert alert-warning">No se encontraron resultados para "' + query + '"</div>';
                }

                $('#searchResults').html(html);
                $('#searchModal').modal('show');
            }
        });
    });
</script>
<!-- Qmunica AI Assistant Sidebar -->
<style>
    :root {
        --qmunica-blue: #007bff;
        --qmunica-dark: #2c3e50;
        --qmunica-light: #f8f9fa;
        --sidebar-width: 350px;
    }

    body.chat-open {
        margin-right: var(--sidebar-width);
        transition: margin-right 0.3s ease;
    }

    #qmunica-ai-sidebar {
        position: fixed;
        top: 0;
        right: -400px;
        /* Hidden by default */
        width: var(--sidebar-width);
        height: 100vh;
        background: white;
        box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
        z-index: 10000;
        display: flex;
        flex-direction: column;
        transition: right 0.3s ease;
        border-left: 1px solid #eee;
        font-family: 'Segoe UI', system-ui, sans-serif;
    }

    #qmunica-ai-sidebar.open {
        right: 0;
    }

    /* Toggle Button (Floating) */
    #qmunica-ai-toggle {
        position: fixed;
        bottom: 30px;
        right: 30px;
        background: var(--qmunica-blue);
        color: white;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        cursor: pointer;
        border: none;
        z-index: 10001;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        transition: transform 0.2s, right 0.3s ease;
        animation: pulse-glow 3s infinite;
    }

    @keyframes pulse-glow {
        0% {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        50% {
            box-shadow: 0 4px 25px rgba(0, 123, 255, 0.6);
        }

        100% {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
    }

    #qmunica-ai-toggle:hover {
        transform: scale(1.1);
        animation: none;
    }

    #qmunica-ai-toggle.sidebar-active {
        right: 370px;
        /* Move with sidebar */
        background: var(--qmunica-dark);
        animation: none;
    }

    /* CTA Tooltip ("The Wink") */
    .ai-cta-tooltip {
        position: fixed;
        bottom: 45px;
        /* Center-ish with button */
        right: 100px;
        background: white;
        color: #333;
        padding: 10px 15px;
        border-radius: 20px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        font-family: 'Segoe UI', system-ui, sans-serif;
        font-size: 14px;
        font-weight: 500;
        z-index: 10000;
        pointer-events: none;
        /* Let clicks pass through if needed, though it's beside */
        opacity: 0;
        transform: translateX(20px);
        animation: slideInFade 1s 1s forwards, float 3s 2s infinite ease-in-out;
        max-width: 250px;
        border: 1px solid #e1e1e1;
    }

    .ai-cta-tooltip::after {
        content: '';
        position: absolute;
        right: -8px;
        top: 50%;
        transform: translateY(-50%);
        border-width: 8px 0 8px 8px;
        border-style: solid;
        border-color: transparent transparent transparent white;
    }

    /* Close CTA when sidebar is open */
    .sidebar-active~.ai-cta-tooltip {
        display: none;
    }

    @keyframes slideInFade {
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    @keyframes float {

        0%,
        100% {
            transform: translateY(0);
        }

        50% {
            transform: translateY(-5px);
        }
    }

    /* Header */
    .ai-sidebar-header {
        padding: 20px;
        background: linear-gradient(135deg, var(--qmunica-blue), #0056b3);
        color: white;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .ai-sidebar-title h3 {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
    }

    .ai-sidebar-title small {
        opacity: 0.8;
        font-size: 12px;
    }

    .ai-close-btn {
        background: none;
        border: none;
        color: white;
        font-size: 20px;
        cursor: pointer;
        padding: 5px;
    }

    /* Messages Area */
    .ai-messages-container {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: var(--qmunica-light);
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .ai-message {
        max-width: 90%;
        padding: 12px 16px;
        border-radius: 12px;
        font-size: 14px;
        line-height: 1.5;
        position: relative;
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .ai-message.bot {
        background: white;
        color: #333;
        align-self: flex-start;
        border: 1px solid #e1e1e1;
        border-top-left-radius: 2px;
    }

    .ai-message.user {
        background: var(--qmunica-blue);
        color: white;
        align-self: flex-end;
        border-bottom-right-radius: 2px;
    }

    .ai-avatar {
        width: 24px;
        height: 24px;
        margin-bottom: 5px;
        display: block;
        font-size: 20px;
    }

    /* Code blocks styles for bot responses */
    .ai-message pre {
        background: #2d2d2d;
        color: #ccc;
        padding: 10px;
        border-radius: 6px;
        overflow-x: auto;
        margin-top: 5px;
        font-size: 12px;
    }

    /* Input Area */
    .ai-input-area {
        padding: 20px;
        background: white;
        border-top: 1px solid #eee;
        display: flex;
        gap: 10px;
    }

    .ai-input-wrapper {
        flex: 1;
        position: relative;
    }

    .ai-input-area textarea {
        width: 100%;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 10px;
        padding-right: 40px;
        resize: none;
        height: 45px;
        /* Initial height */
        max-height: 120px;
        font-family: inherit;
        outline: none;
        transition: border-color 0.2s;
    }

    .ai-input-area textarea:focus {
        border-color: var(--qmunica-blue);
    }

    .ai-send-btn {
        background: var(--qmunica-blue);
        color: white;
        border: none;
        width: 45px;
        height: 45px;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
    }

    .ai-send-btn:hover {
        background: #0056b3;
    }

    .ai-send-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
    }

    /* Typing Indicator */
    .typing-indicator {
        display: flex;
        gap: 4px;
        padding: 10px;
        align-self: flex-start;
        display: none;
        /* Hidden by default */
    }

    .typing-dot {
        width: 6px;
        height: 6px;
        background: #bbb;
        border-radius: 50%;
        animation: bounce 1.4s infinite ease-in-out both;
    }

    .typing-dot:nth-child(1) {
        animation-delay: -0.32s;
    }

    .typing-dot:nth-child(2) {
        animation-delay: -0.16s;
    }

    @keyframes bounce {

        0%,
        80%,
        100% {
            transform: scale(0);
        }

        40% {
            transform: scale(1);
        }
    }
</style>

<div id="qmunica-ai-toggle" onclick="toggleSidebar()">
    <span>‚ú®</span>
</div>

<div id="qmunica-ai-sidebar">
    <div class="ai-sidebar-header">
        <div class="ai-sidebar-title">
            <h3>Qmunica AI</h3>
            <small>Asistente de Documentaci√≥n Inteligente</small>
        </div>
        <button class="ai-close-btn" onclick="toggleSidebar()">‚úï</button>
    </div>

    <div class="ai-messages-container" id="ai-messages">
        <!-- Welcome Message will be injected by JS if history is empty -->
    </div>

    <div class="ai-input-area">
        <div class="ai-input-wrapper">
            <textarea id="ai-input" placeholder="Pregunta sobre playlists, widgets, etc..." rows="1"
                onkeypress="handleInputKey(event)"></textarea>
        </div>
        <button class="ai-send-btn" id="ai-send-btn" onclick="sendAiMessage()">
            ‚û§
        </button>
    </div>
</div>

<script>
    // CONFIGURATION
    const AI_WEBHOOK_URL = 'https://informes.qmunica.com/webhook/ed1de65e-3d53-43f8-a330-37f0bd028b35/chat';
    const STATE_KEY = 'qmunica_sidebar_state';
    const HISTORY_KEY = 'qmunica_chat_history';
    const SESSION_KEY = 'qmunica_chat_session';

    let sidebarOpen = false;

    // Initialize on load
    document.addEventListener('DOMContentLoaded', () => {
        loadState();
        loadHistory();
    });

    function loadState() {
        const savedState = localStorage.getItem(STATE_KEY);
        sidebarOpen = savedState === 'open';

        const sidebar = document.getElementById('qmunica-ai-sidebar');
        const toggleBtn = document.getElementById('qmunica-ai-toggle');
        const tooltip = document.querySelector('.ai-cta-tooltip');

        if (sidebarOpen) {
            sidebar.classList.add('open');
            toggleBtn.classList.add('sidebar-active');
            toggleBtn.innerHTML = '‚úï';
            if (tooltip) tooltip.style.display = 'none';
            document.body.classList.add('chat-open');
        }
    }

    function toggleSidebar() {
        sidebarOpen = !sidebarOpen;
        localStorage.setItem(STATE_KEY, sidebarOpen ? 'open' : 'closed');

        const sidebar = document.getElementById('qmunica-ai-sidebar');
        const toggleBtn = document.getElementById('qmunica-ai-toggle');
        const tooltip = document.querySelector('.ai-cta-tooltip');

        if (sidebarOpen) {
            sidebar.classList.add('open');
            toggleBtn.classList.add('sidebar-active');
            toggleBtn.innerHTML = '‚úï';
            if (tooltip) tooltip.style.display = 'none';
            document.body.classList.add('chat-open');
        } else {
            sidebar.classList.remove('open');
            toggleBtn.classList.remove('sidebar-active');
            toggleBtn.innerHTML = '‚ú®';
            if (tooltip) tooltip.style.display = 'block';
            document.body.classList.remove('chat-open');
        }
    }

    function handleInputKey(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendAiMessage();
        }
    }

    async function sendAiMessage() {
        const inputField = document.getElementById('ai-input');
        const message = inputField.value.trim();
        const sendBtn = document.getElementById('ai-send-btn');
        const messagesContainer = document.getElementById('ai-messages');

        if (!message) return;

        // UI Updates
        addMessageToUI(message, 'user');
        saveMessageToHistory(message, 'user');

        inputField.value = '';
        sendBtn.disabled = true;

        // Show typing
        const typing = createTypingIndicator();
        messagesContainer.appendChild(typing);
        scrollToBottom();

        try {
            // Generate or retrieve session ID
            let sessionId = localStorage.getItem(SESSION_KEY);
            if (!sessionId) {
                sessionId = 'sess_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem(SESSION_KEY, sessionId);
            }

            console.log("Enviando mensaje a:", AI_WEBHOOK_URL);

            // API Call
            const response = await fetch(AI_WEBHOOK_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    chatInput: message,
                    sessionId: sessionId
                })
            });

            // Check for HTML response (common mistake with N8n Hosted Chat)
            const contentType = response.headers.get("content-type");
            if (contentType && contentType.includes("text/html")) {
                console.error("Recibido HTML en lugar de JSON. N8n est√° en modo Hosted Chat o devolviendo error 404/500.");
                throw new Error("N8n devolvi√≥ HTML (Modo Chat) en lugar de JSON (Modo API).");
            }

            if (!response.ok) {
                throw new Error(`Error HTTP: ${response.status}`);
            }

            const data = await response.json();
            console.log("Respuesta recibida:", data);

            // Extract text
            let botText = "Lo siento, no he leido nada.";
            const payload = Array.isArray(data) ? data[0] : data;

            if (typeof payload === 'string') botText = payload;
            else if (payload.output) botText = payload.output;
            else if (payload.message) botText = payload.message;
            else if (payload.text) botText = payload.text;
            else if (payload.content) botText = payload.content;

            // Success
            if (typing.parentNode) typing.parentNode.removeChild(typing);
            addMessageToUI(botText, 'bot');
            saveMessageToHistory(botText, 'bot');

        } catch (error) {
            console.error(error);
            if (typing.parentNode) typing.parentNode.removeChild(typing);

            let errorMsg = "Lo siento, hubo un error de conexi√≥n.";
            if (error.message.includes("HTML")) errorMsg = "‚ö†Ô∏è Error: N8n configurado como 'Chat' en vez de 'Webhook'.";
            if (error.message.includes("Failed to fetch")) errorMsg = "‚ö†Ô∏è Error CORS: Configura 'Allowed Origins: *' en el nodo Webhook de N8n.";

            addMessageToUI(errorMsg, 'bot');
            saveMessageToHistory(errorMsg, 'bot'); // Save error too so user sees it
        } finally {
            sendBtn.disabled = false;
            inputField.focus();
        }
    }

    function addMessageToUI(text, type) {
        const container = document.getElementById('ai-messages');
        const msgDiv = document.createElement('div');
        msgDiv.className = `ai-message ${type}`;

        if (!text) text = "...";

        let formattedText = text
            .replace(/\n/g, '<br>')
            .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');

        msgDiv.innerHTML = formattedText;
        container.appendChild(msgDiv);
        scrollToBottom();
    }

    // --- History Management ---

    function saveMessageToHistory(text, type) {
        let history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
        history.push({ text, type, timestamp: new Date().getTime() });
        // Optional: limit history size (e.g., last 50 messages)
        if (history.length > 50) history = history.slice(history.length - 50);
        localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
    }

    function loadHistory() {
        const container = document.getElementById('ai-messages');
        let history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');

        container.innerHTML = ''; // Clear existing

        if (history.length === 0) {
            // Default Welcome Message if no history
            const welcomeDiv = document.createElement('div');
            welcomeDiv.className = 'ai-message bot';
            welcomeDiv.innerHTML = '<div class="ai-avatar">ü§ñ</div>Hola, soy tu asistente experto en Qmunica DS. <br><br>Puedo ayudarte a buscar informaci√≥n en el manual o adaptar ejemplos de c√≥digo.<br><strong>¬øQu√© necesitas saber hoy?</strong>';
            container.appendChild(welcomeDiv);
        } else {
            // Load saved messages
            history.forEach(msg => {
                addMessageToUI(msg.text, msg.type);
            });
            // Restore scroll position? usually bottom is best
            setTimeout(scrollToBottom, 100);
        }
    }

    // Helper for typing
    function createTypingIndicator() {
        const div = document.createElement('div');
        div.className = 'typing-indicator';
        div.style.display = 'flex';
        div.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
        return div;
    }

    function scrollToBottom() {
        const container = document.getElementById('ai-messages');
        container.scrollTop = container.scrollHeight;
    }
</script>
</body>

</html>